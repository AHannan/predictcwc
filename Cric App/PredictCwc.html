<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
        crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

    <script src="./script_basic.js"></script>

    <style>
        td.sum {
            font-size: 2em;
            text-align: center;
        }

        .sort{
            cursor: pointer;
        }

        .tab-heading {
            color: red;
        }

        table {
            border-collapse: collapse;
            /*remove spaces within cells */
            margin: 25px 0px;
            font-size: 0.9em;
            min-width: 400px;
        }

        .heading {
            width: 50px;
        }

        .cell {
            height: 50px;
        }

        .team {
            height: 50px;
            width: 100px;
        }

        .team-image {
            width: 20px;
            height: 20px;
        }

        .input-number {
            width: 100%;
            height: 100%;
            text-align: center;
            background-color: #f7eca8;
        }

        .team-name {
            padding: 2px 0 0 4px;
        }

        .cell-won {
            background-color: #4CAF50;
            border: none;
            color: white;
            text-align: center;
        }

        .cell-draw {
            background-color: rgb(186, 199, 74);
            border: none;
            color: white;
            text-align: center;
        }

        .cell-lost {
            background-color: rgb(182, 82, 95);
            border: none;
            color: white;
            text-align: center;
        }

        .cell-disabled {
            background-color: rgb(99, 92, 93);
            border: none;
            color: white;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="content">
        <!-- <div class="row col-md-12">
            <h2>Predict CWC</h2>
        </div> -->

        <div class="col-md-8">
            <h3 class="tab-heading">Cricket World Cup - All Combinations</h3>
            <table id="tbl-details">
                
            </table>
        </div>
        <div class="col-md-4">
            <h3 class="tab-heading">
                Qualification Chance
            </h3>
            <table id="tbl-chances">
                <tr>
                    <th>Teams</th>
                    <th class="heading sort" id="head-chance" onclick="sortTable(1, 'tbl-chances')">Chance</th>
                </tr>
                <tr>
                    <td class="team" id="team-eng">
                        <img class="team-image">
                        <span class="team-name">England</span>
                    </td>
                    <td id="chance-eng">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-ind">
                        <img class="team-image">
                        <span class="team-name">India</span>
                    </td>
                    <td id="chance-ind">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-aus">
                        <img class="team-image">
                        <span class="team-name">Australia</span>
                    </td>
                    <td id="chance-aus">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-nzl">
                        <img class="team-image">
                        <span class="team-name">Newzealand</span>
                    </td>
                    <td id="chance-nzl">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-pak">
                        <img class="team-image">
                        <span class="team-name">Pakistan</span>
                    </td>
                    <td id="chance-pak">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-ban">
                        <img class="team-image">
                        <span class="team-name">Bangladesh</span>
                    </td>
                    <td id="chance-ban">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-win">
                        <img class="team-image">
                        <span class="team-name">West Indies</span>
                    </td>
                    <td id="chance-win">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-saf">
                        <img class="team-image">
                        <span class="team-name">South Africa</span>
                    </td>
                    <td id="chance-saf">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-sri">
                        <img class="team-image">
                        <span class="team-name">Sri Lanka</span>
                    </td>
                    <td id="chance-sri">0</td>
                </tr>
                <tr>
                    <td class="team" id="team-afg">
                        <img class="team-image">
                        <span class="team-name">Afghanistan</span>
                    </td>
                    <td id="chance-afg">0</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        
        /* ---
        Pre Steps Functions 
        --- */
        
        function refreshChanceTable() {
            // teamInfo is actually a global variable here
            $.each(teamInfo, function (team) {
                var myVar = teamInfo[team]['scores'];
                var chance = 0;
                $.each(myVar, function (v) {
                   chance += parseFloat(teamInfo[team]['scores'][v]);
                });               

                chance = chance.toFixed(1);

                $('#chance-' + team).text(chance);
                $('#row-'+team+' .sum').text(chance);

            });

            sortTable(1, 'tbl-chances');
            sortTable(1, 'tbl-chances');
        }

        function getInputNumber(val, match) {
            return '<input id="num-' + match + '" type="number" value="' + val + '" class="input-number" min="0" max="1" step=".1">';
        }

        function getTeam(match, num) {
            var teamNames = match.split("-");
            return teamNames[num - 1];
        }

        function getKeysCount(myArray){
            return Object.keys(myArray).length;
        }

        /* --- 
        DATA 
        --- */

        // Team Info includes:
        // Order of teams arrangement. Note: This order is important        
        // Image numbers as present in espn cric info
        var teamInfo = 
        {
            "eng": { "imageNumber":  1, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Eng" },
            "ind": { "imageNumber":  6, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Ind" },
            "aus": { "imageNumber":  2, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Aus" },
            "nzl": { "imageNumber":  5, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Nzl" },
            "pak": { "imageNumber":  7, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Pak" },
            "ban": { "imageNumber": 25, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Ban" },
            "win": { "imageNumber":  4, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Win" },
            "saf": { "imageNumber":  3, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Saf" },
            "sri": { "imageNumber":  8, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Sri" },
            "afg": { "imageNumber": 40, "matches": 0, "won": 0, "lost": 0, "drawn" : 0, "points" : 0, "chance" : 0, "scores": {}, "teamName": "Afg" },
        };

        /*
        Round robin for 10 teams have 45 matches.
        Keys are created as "<team1>-<team2>"
        -   Result is the winning probabilty of team 1.
        -   Probability of Team 2 is auto-calculated below
        -   Completed describes if a game is completed
        */
        var matches =
        {
            "eng-saf": { "result": 1, "completed": 1 },
            "pak-win": { "result": 0, "completed": 1 },
            "sri-nzl": { "result": 0, "completed": 1 },
            "aus-afg": { "result": 1, "completed": 1 },
            "ban-saf": { "result": 1, "completed": 1 },
            "pak-eng": { "result": 1, "completed": 1 },
            "sri-afg": { "result": 1, "completed": 1 },
            "saf-ind": { "result": 0, "completed": 1 },
            "ban-nzl": { "result": 0, "completed": 1 },            
            "aus-win": { "result": 1, "completed": 1 },
            "pak-sri": { "result": 0.5, "completed": 1 },
            "ban-eng": { "result": 0, "completed": 1 },
            "afg-nzl": { "result": 0, "completed": 1 },
            
        };
        
        var matches_copy = {};

        var completedTeams = [];
        
        //if(local)
        setMyIP();
        
        /* STEPS */

        // Setup tbl-details
        var tableHeader = '<tr><th class="heading" style="text-align: right;padding-right: 10px;">versus</th>';
        var tableRows = "";
        $.each(teamInfo, function (team) {            
            //var team = 'eng';
            var teamName = teamInfo[team]['teamName'];
            
            //  Start row
            tableRows += '<tr id="row-'+team+'">'; 
            // cell_team
            tableRows += '<td class="team" id="team-'+team+'"><img class="team-image"><span class="team-name">'+teamName+'</span></td>'; 
            $.each(teamInfo, function (versus) {
                // Add cell
                var score = '';
                if(team == versus){
                    score = '-';
                }
                tableRows += '<td class="cell" id="'+team+"-"+versus+'">'+score+'</td>';
            });    
            // Add cell sum        
            tableRows += '<td class="sum"></td>';

            // End row
            tableRows += '</tr>';

            tableHeader += '<th class="heading" id="head-'+team+'">'+teamName+'</th>'
        });

        tableHeader += '<th class="heading sum sort" onclick="sortTable(11, '+"'"+'tbl-details'+"'"+')">Sum</th>';
        tableHeader += '</tr>';

        var tableContent = tableHeader + tableRows;
        $('#tbl-details').html(tableContent);

        $.each(teamInfo, function (team) {
            completedTeams.push(team);

            // Disable matches i.e. a team's match against itself
            $("#" + team + "-" + team).addClass("cell-disabled");

            // Utilizing this loop to setup images as well
            // To-do: move these images locally from espn
            $('#team-' + team + ' img').attr("src", "https://a1.espncdn.com/combiner/i?img=/i/teamlogos/cricket/500/" + teamInfo[team]["imageNumber"] + ".png&amp;h=50&amp;w=50")

            //console.log('------- ' + team);
            // Add remaining matches
            
            $.each(teamInfo, function (versus) {
                var seq1 = team + "-" + versus;
                var seq2 = versus + "-" + team;
                //console.log('>' + seq1);                

                if(completedTeams.includes(versus)){
                    // do nothing
                } else if (matches[seq1]){
                    matches_copy[seq1] = matches[seq1];
                } else if(matches[seq2]){
                    matches_copy[seq1] = matches[seq2];
                    matches_copy[seq1]['result'] = 1 - matches_copy[seq1]['result'];
                }else{                    
                    matches_copy[seq1] = {"result": 0.5};
                }                
            });
        });
        matches = matches_copy; 

        // Calculate scores for table 2
        $.each(matches, function (match) {
            
            var tName_1 = getTeam(match, 1);
            var tName_2 = getTeam(match, 2);

            var tSeq_1 = tName_1 + "-" + tName_2;
            var tSeq_2 = tName_2 + "-" + tName_1;

            var tClass_1 = 'cell-draw';
            var tClass_2 = 'cell-draw';
            
            var tResult_1 = matches[match]["result"]; // result is the probability/match result of first team            
            var tResult_2 = (1 - tResult_1).toFixed(1); // get result of team 2 from team 1
        
            // Set scores for "Combination" table
            if (!matches[match]["completed"]) {
                // Incompleted matches: Add a number textbox                
                $("#" + tSeq_1).html(getInputNumber(tResult_1, tSeq_1));
                $("#" + tSeq_2).html(getInputNumber(tResult_2, tSeq_2));
                
            } else {
                // Completed matches: Add Label
                $("#" + tSeq_1).text(tResult_1);
                $("#" + tSeq_2).text(tResult_2);

                teamInfo[tName_1]['matches'] += 1;
                teamInfo[tName_2]['matches'] += 1;

                // Setup color themes for completed matches
                if(tResult_1 > tResult_2){
                    tClass_1 = 'cell-won'; // WON: team 1
                    tClass_2 = 'cell-lost';

                    teamInfo[tName_1]['won'] += 1; teamInfo[tName_1]['points'] += 2;
                    teamInfo[tName_2]['lost'] += 1;
                } else if(tResult_1 < tResult_2){
                    tClass_1 = 'cell-lost';  // WON: team 2
                    tClass_2 = 'cell-won';

                    teamInfo[tName_1]['lost'] += 1;
                    teamInfo[tName_2]['won'] += 1; teamInfo[tName_2]['points'] += 2;
                }else{
                    teamInfo[tName_1]['drawn'] += 1; teamInfo[tName_1]['points'] += 1;
                    teamInfo[tName_2]['drawn'] += 1; teamInfo[tName_2]['points'] += 1;
                }

                $("#" + tSeq_1).addClass(tClass_1);
                $("#" + tSeq_2).addClass(tClass_2);
            }
            
            // Update Team Info
            teamInfo[tName_1]['scores'][tName_2] = tResult_1;
            teamInfo[tName_2]['scores'][tName_1] = tResult_2;

        });
        
        // Refresh Table
        refreshChanceTable(teamInfo);
        
        /* --- 
        Post Steps Functions 
        --- */
        function numInputFunction(id, value) {
            
            var match = id.replace("num-", "");
            
            var tName_1 = getTeam(match, 1);
            var tName_2 = getTeam(match, 2);

            var tSeq_1 = tName_1 + "-" + tName_2;
            var tSeq_2 = tName_2 + "-" + tName_1;

            var tResult_1 = value; // same as the value of the number box
            var tResult_2 = (1 - tResult_1).toFixed(1); // get result of team 2 from team 1

            $("#num-" + tSeq_1).val(tResult_1);
            $("#num-" + tSeq_2).val(tResult_2); // Only needed to update the second team only though

            // Update scores of both teams against each other
            this.teamInfo[tName_1]['scores'][tName_2] = tResult_1;
            this.teamInfo[tName_2]['scores'][tName_1] = tResult_2;

            // Refresh Chance Table
            refreshChanceTable(teamInfo);

        }
        
        $(function () {
            $(":input").focus(function() { $(this).select(); } );
            $(":input").bind('keyup mouseup', function () {
                if (this.value) {
                    if (this.value > 1 || this.value < 0) {
                        this.value = 1;
                    } else {
                        numInputFunction(this.id, this.value);
                    }
                } else {
                    this.value = 0;
                }
            });
        });
        
    </script>
</body>

</html>